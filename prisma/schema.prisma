generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Job {
  id                        String         @id
  title                     String
  company                   String
  companyLogo               String?
  locationRaw               String?
  city                      String?
  citySlug                  String?
  countryCode               String?
  remote                    Boolean?
  remoteRegion              String?
  remoteMode                String?
  salaryRaw                 String?
  descriptionHtml           String?
  salaryMin                 BigInt?
  salaryMax                 BigInt?
  salaryCurrency            String?
  salaryPeriod              String?
  minAnnual                 BigInt?
  maxAnnual                 BigInt?
  currency                  String?
  isHighSalary              Boolean        @default(false)
  isHundredKLocal           Boolean        @default(false)
  isHighSalaryLocal         Boolean        @default(false)
  type                      String?
  source                    String
  applyUrl                  String?
  url                       String?
  roleSlug                  String?
  skillsJson                String?
  requirementsJson          String?
  benefitsJson              String?
  externalId                String?
  isExpired                 Boolean        @default(false)
  lastSeenAt                DateTime?
  postedAt                  DateTime?
  createdAt                 DateTime       @default(now())
  updatedAt                 DateTime       @updatedAt
  companyId                 String?
  locationId                String?
  dedupeKey                 String?
  sourcePriority            Int            @default(20)
  isUnverifiedBoardJob      Boolean        @default(false)
  experienceLevel           String?        @default("mid")
  employmentType            String?        @default("full-time")
  workArrangement           String?
  visaSponsorship           Boolean        @default(false)
  techStack                 String?
  industry                  String?
  stateCode                 String?
  shortId                   String?        @unique
  aiSummaryJson             Json?
  aiSnippet                 String?
  aiOneLiner                String?        @db.VarChar(180)
  aiEnrichedAt              DateTime?
  locationsJson             Json?
  primaryLocation           Json?
  aiBenefits                Json?
  aiRequirements            Json?
  aiWhyHighPay              String?
  aiModel                   String?
  aiVersion                 String?
  aiQualityScore            Int?
  lastAiEnrichedAt          DateTime?      @db.Timestamptz(6)
  salaryConfidence          Int?           @default(0)
  salaryValidated           Boolean        @default(false)
  salarySource              String?
  salaryParseReason         String?
  salaryNormalizedAt        DateTime?      @db.Timestamptz(6)
  salaryRejectedAt          DateTime?      @db.Timestamptz(6)
  salaryRejectedReason      String?
  needsReview               Boolean        @default(false)
  workArrangementNormalized String?
  companyRef                Company?       @relation(fields: [companyId], references: [id])
  locationRef               Location?      @relation(fields: [locationId], references: [id])
  roleInference             RoleInference?

  @@unique([externalId, source], name: "externalId_source")
  @@unique([companyId, dedupeKey], name: "company_dedupeKey")
  @@index([source])
  @@index([roleSlug])
  @@index([countryCode])
  @@index([isHighSalary])
  @@index([isHundredKLocal])
  @@index([isHighSalaryLocal])
  @@index([companyId])
  @@index([externalId])
  @@index([remoteMode])
  @@index([currency])
  @@index([isExpired])
  @@index([dedupeKey])
  @@index([experienceLevel])
  @@index([industry])
  @@index([workArrangement])
  @@index([stateCode])
  @@index([salaryValidated])
  @@index([salaryConfidence])
  @@index([salarySource])
  @@index([salaryNormalizedAt])
  @@index([needsReview])
  @@index([aiQualityScore])
  @@index([lastAiEnrichedAt])
}

model CompanyATS {
  id           String   @id @default(cuid())
  companyName  String
  companySlug  String   @unique
  atsType      String
  atsUrl       String   @unique
  discoveredBy String
  isActive     Boolean  @default(true)
  lastScraped  DateTime?
  jobCount     Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([atsType])
  @@index([isActive])
  @@index([lastScraped])
}

model SalaryAggregate {
  id            String   @id @default(cuid())
  sliceType     String
  sliceSlug     String
  currency      String
  minConfidence Int      @default(80)
  jobCount      Int      @default(0)
  minAnnual     BigInt?
  maxAnnual     BigInt?
  avgAnnual     BigInt?
  medianAnnual  BigInt?
  p75Annual     BigInt?
  computedAt    DateTime @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@unique([sliceType, sliceSlug, currency], name: "slice_currency_unique", map: "slice_currency_unique")
  @@index([sliceType])
  @@index([sliceSlug])
  @@index([jobCount])
}

model Company {
  id                 String          @id @default(cuid())
  name               String
  slug               String          @unique
  website            String?
  logoUrl            String?
  description        String?
  linkedinUrl        String?
  sizeBucket         String?
  tagsJson           String?
  fundingSummary     String?
  industry           String?
  atsProvider        String?
  atsUrl             String?
  atsSlug            String?
  lastScrapedAt      DateTime?
  scrapeStatus       String?
  scrapeError        String?
  jobCount           Int             @default(0)
  totalJobCount      Int?
  lastJobCountSyncAt DateTime?
  countryCode        String?
  headquarters       String?
  employeeCount      Int?
  fundingStage       String?
  foundedYear        Int?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  sources            CompanySource[]
  jobs               Job[]

  @@index([atsProvider])
  @@index([scrapeStatus])
  @@index([sizeBucket])
  @@index([industry])
  @@index([fundingStage])
}

model CompanySource {
  id            String    @id @default(cuid())
  companyId     String
  sourceType    String
  url           String
  atsProvider   String?
  isActive      Boolean   @default(true)
  lastScrapedAt DateTime?
  lastJobCount  Int       @default(0)
  scrapeStatus  String?
  scrapeError   String?
  priority      Int       @default(100)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  company       Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, url])
  @@index([atsProvider])
  @@index([isActive])
  @@index([scrapeStatus])
  @@index([priority])
}

model JobSlice {
  id          String   @id @default(cuid())
  slug        String   @unique
  type        String
  filtersJson String
  jobCount    Int      @default(0)
  title       String?
  description String?
  h1          String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type])
  @@index([jobCount])
}

model Location {
  id           String   @id @default(cuid())
  locationRaw  String
  city         String?
  citySlug     String?
  region       String?
  countryCode  String?
  isRemote     Boolean? @default(false)
  remoteRegion String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  jobs         Job[]
}

model Skill {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
}

model RoleInference {
  id        String   @id @default(cuid())
  jobId     String   @unique
  roleSlug  String?
  seniority String?
  tagsJson  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  job       Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
}

model ScrapeRun {
  id               String    @id @default(cuid())
  startedAt        DateTime  @default(now())
  completedAt      DateTime?
  companiesTotal   Int       @default(0)
  companiesScraped Int       @default(0)
  companiesFailed  Int       @default(0)
  jobsFound        Int       @default(0)
  jobsNew          Int       @default(0)
  jobsUpdated      Int       @default(0)
  jobsExpired      Int       @default(0)
  status           String    @default("running")
  errorLog         String?
  triggerType      String?

  @@index([status])
  @@index([startedAt])
}

model AiRunLedger {
  id            String   @id @default(cuid())
  day           DateTime @unique
  jobsProcessed Int      @default(0)
  tokensIn      Int      @default(0)
  tokensOut     Int      @default(0)
  lastRunAt     DateTime @updatedAt
  createdAt     DateTime @default(now())
}
